<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteorite Landings Data</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h2>Meteorite Landings Data Visualization</h2>
    <div id="plot"></div>
    <div id="csvPlot"></div>

    <script>
        // Step 1: Load and process the JSON data
        fetch('https://tngqpid.github.io/TNGQpid.github.io/meteorite_data.json')
            .then(response => response.json())
            .then(data => {
                const cleanedData = cleanData(data);
                const aggregatedData = aggregateData(cleanedData);
                visualizeData(aggregatedData);
            })
            .catch(error => console.error("Error loading JSON:", error));

        // Step 2: Load and process the CSV data using PapaParse
        Papa.parse('https://tngqpid.github.io/TNGQpid.github.io/meteorite_data.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const csvData = results.data;
                const cleanedCSVData = cleanData(csvData);
                const aggregatedCSVData = aggregateData(cleanedCSVData);
                visualizeCSVData(aggregatedCSVData);
            }
        });

        // Data Cleaning Function (removes missing/invalid data and converts types)
        function cleanData(data) {
            return data.filter(item => {
                return item.mass_g && item.year && item.longitude && item.latitude;
            }).map(item => {
                return {
                    ...item,
                    mass_g: parseFloat(item.mass_g), // Ensure mass is a float
                    year: parseInt(item.year), // Ensure year is an integer
                    longitude: parseFloat(item.longitude),
                    latitude: parseFloat(item.latitude)
                };
            });
        }

        // Aggregation Function (Group data by year and calculate trends)
        function aggregateData(data) {
            const yearData = {};
            data.forEach(item => {
                if (!yearData[item.year]) {
                    yearData[item.year] = { count: 0, totalMass: 0 };
                }
                yearData[item.year].count += 1;
                yearData[item.year].totalMass += item.mass_g;
            });

            const aggregated = Object.keys(yearData).map(year => ({
                year: year,
                count: yearData[year].count,
                averageMass: yearData[year].totalMass / yearData[year].count
            }));

            return aggregated;
        }

        // Visualize Data with Plotly (Interactive Chart)
        function visualizeData(data) {
            const years = data.map(item => item.year);
            const counts = data.map(item => item.count);
            const avgMass = data.map(item => item.averageMass);

            const trace1 = {
                x: years,
                y: counts,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Meteorite Landings'
            };

            const trace2 = {
                x: years,
                y: avgMass,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Average Meteorite Mass (g)',
                yaxis: 'y2'
            };

            const layout = {
                title: 'Meteorite Landings Trends',
                xaxis: { title: 'Year' },
                yaxis: { title: 'Number of Landings' },
                yaxis2: {
                    title: 'Average Mass (g)',
                    overlaying: 'y',
                    side: 'right'
                }
            };

            Plotly.newPlot('plot', [trace1, trace2], layout);
        }

        // Visualize CSV Data (could be a map or another type of plot)
        function visualizeCSVData(data) {
            const trace = {
                x: data.map(item => item.longitude),
                y: data.map(item => item.latitude),
                mode: 'markers',
                type: 'scatter',
                text: data.map(item => item.place),
                marker: { color: 'rgba(152, 0, 67, .8)', size: 12 }
            };

            const layout = {
                title: 'Meteorite Landing Locations',
                xaxis: { title: 'Longitude' },
                yaxis: { title: 'Latitude' },
                showlegend: false
            };

            Plotly.newPlot('csvPlot', [trace], layout);
        }
    </script>
</body>
</html>
